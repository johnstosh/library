<!-- (c) Copyright 2025 by Muczynski -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#" id="page-title">Library Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="section-menu" style="display: none;" data-test="section-menu">
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('libraries', event)" data-test="menu-libraries">Libraries</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showSection('authors', event)" data-test="menu-authors">Authors</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showSection('books', event)" data-test="menu-books">Books</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="createBookByPhoto()" data-test="menu-book-by-photo">Book-by-Photo</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('books-from-feed', event)" data-test="menu-books-from-feed">Books-from-Feed</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('photos', event)" data-test="menu-photos">Photos</button>
                </li>
                <li class="nav-item public-item">
                    <button class="nav-link" onclick="showSection('search', event)" data-test="menu-search">Search</button>
                </li>
                <li class="nav-item public-item" data-test="menu-library-card-item">
                    <button class="nav-link" onclick="showSection('library-card', event)" data-test="menu-library-card">Library Card</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('users', event)" data-test="menu-users">Users</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showSection('loans', event)" data-test="menu-loans">Loans</button>
                </li>
                <li class="nav-item public-item" data-test="menu-test-data-item">
                    <button class="nav-link" onclick="showSection('test-data', event)" data-test="menu-test-data">Test Data</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('global-settings', event)" data-test="menu-global-settings">Global Settings</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('loc-bulk-lookup', event)" data-test="menu-loc-bulk-lookup">LOC Bulk Lookup</button>
                </li>
                <li class="nav-item librarian-only">
                    <button class="nav-link" onclick="showSection('labels', event)" data-test="menu-labels">Labels</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showSection('settings', event)" data-test="menu-settings">Settings</button>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <button class="nav-link" id="login-menu-btn" onclick="showLoginForm()" data-test="menu-login">Login</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="logout-menu-btn" onclick="logout()" data-test="menu-logout" style="display: none;">Logout</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div id="login-form" data-test="login-form" class="col-md-6 offset-md-3" style="display: none;">
        <h2 data-test="login-header">Login</h2>
        <form id="login" name="login" action="/login" method="post">
            <div class="mb-3">
                <label for="username" class="form-label">Name:</label>
                <input type="text" id="username" name="username" class="form-control" autocomplete="username" required data-test="login-username">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password:</label>
                <input type="password" id="password" name="password" class="form-control" autocomplete="current-password" required data-test="login-password">
            </div>
            <button type="submit" name="login-submit" class="btn btn-primary" data-test="login-submit" )">Login</button>
        </form>
        <div class="text-center my-3">
            <span class="text-muted">or</span>
        </div>
        <div class="d-grid">
            <a href="/oauth2/authorization/google" class="btn btn-outline-primary" data-test="google-sso-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-google me-2" viewBox="0 0 16 16">
                    <path d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"/>
                </svg>
                Sign in with Google
            </a>
        </div>
        <div id="login-error" class="alert alert-danger mt-3" style="display: none;" data-test="login-error"></div>
    </div>

    <div id="main-content" style="display: none;" data-test="main-content">
    <div class="container" data-test="container">
        <div id="libraries-section" class="section" data-test="libraries-section">
            <h2 data-test="libraries-header">Libraries</h2>
            <ul id="library-list" class="list-group mb-3" data-test="library-list"></ul>
            <div class="librarian-only" data-test="libraries-form">
                <h3>Add Library</h3>
                <div class="input-group mb-3">
                    <input type="text" id="new-library-name" class="form-control" placeholder="New library name" data-test="new-library-name">
                    <input type="text" id="new-library-hostname" class="form-control" placeholder="Hostname" data-test="new-library-hostname">
                    <button id="add-library-btn" class="btn btn-primary" onclick="addLibrary()" data-test="add-library-btn">Add Library</button>
                </div>
            </div>
        </div>

        <div id="authors-section" class="section" data-test="authors-section">
            <h2 data-test="authors-header">Authors</h2>
            <table class="table" data-test="author-table">
                <thead>
                <tr>
                    <th scope="col">Photo</th>
                    <th scope="col">Author</th>
                    <th scope="col">Books</th>
                    <th scope="col">Actions</th>
                </tr>
                </thead>
                <tbody id="author-list-body" data-test="author-list-body">
                </tbody>
            </table>
            <div class="librarian-only" data-test="authors-form">
                <div class="mb-3">
                    <label for="new-author-name" class="form-label">Author Name:</label>
                    <input type="text" id="new-author-name" class="form-control" placeholder="New author name" autocomplete="off" data-test="new-author-name">
                </div>
                <div class="mb-3">
                    <label for="new-author-dob" class="form-label">Date of Birth:</label>
                    <input type="date" id="new-author-dob" class="form-control" autocomplete="off" data-test="new-author-dob">
                </div>
                <div class="mb-3">
                    <label for="new-author-dod" class="form-label">Date of Death:</label>
                    <input type="date" id="new-author-dod" class="form-control" autocomplete="off" data-test="new-author-dod">
                </div>
                <div class="mb-3">
                    <label for="new-author-religion" class="form-label">Religious Affiliation:</label>
                    <input type="text" id="new-author-religion" class="form-control" placeholder="Religious Affiliation" autocomplete="off" data-test="new-author-religion">
                </div>
                <div class="mb-3">
                    <label for="new-author-country" class="form-label">Birth Country:</label>
                    <input type="text" id="new-author-country" class="form-control" placeholder="Birth Country" autocomplete="off" data-test="new-author-country">
                </div>
                <div class="mb-3">
                    <label for="new-author-nationality" class="form-label">Nationality:</label>
                    <input type="text" id="new-author-nationality" class="form-control" placeholder="Nationality" autocomplete="off" data-test="new-author-nationality">
                </div>
                <div class="mb-3">
                    <label for="new-author-bio" class="form-label">Brief Biography:</label>
                    <textarea id="new-author-bio" class="form-control" placeholder="Brief Biography" autocomplete="off" data-test="new-author-bio"></textarea>
                </div>
                <button id="add-author-btn" class="btn btn-primary mb-3" onclick="addAuthor()" data-test="add-author-btn">Add Author</button>
                <button id="cancel-author-btn" class="btn btn-secondary mb-3" onclick="resetAuthorForm()" data-test="cancel-author-btn" style="display: none;">Cancel</button>
                <button id="add-author-photo-btn" class="btn btn-secondary mb-3" onclick="addAuthorPhoto()" data-test="add-author-photo-btn" style="display: none;">Add Photo</button>
                <button id="add-author-photo-google-btn" class="btn btn-secondary mb-3" onclick="addAuthorPhotoFromGooglePhotos()" data-test="add-author-photo-google-btn" style="display: none;">Add Photo from Google Photos</button>
                <input type="hidden" id="current-author-id">
                <input type="file" id="author-photo-upload" style="display: none;" accept="image/*" capture="environment"/>
                <div id="author-photos-container" class="mb-3" style="display: none;" data-test="author-photos-container">
                    <h3 data-test="author-photos-header">Author Photos</h3>
                    <div id="author-photos" data-test="author-photos"></div>
                </div>
            </div>
        </div>

        <div id="books-section" class="section" data-test="books-section">
            <h2 data-test="books-header">Books</h2>
            <table class="table" data-test="book-table">
                <thead>
                <tr>
                    <th scope="col">Photo</th>
                    <th scope="col">Book</th>
                    <th scope="col">LOC Call Number</th>
                    <th scope="col">Loans</th>
                    <th scope="col">Actions</th>
                </tr>
                </thead>
                <tbody id="book-list-body" data-test="book-list-body">
                </tbody>
            </table>
            <div class="librarian-only" data-test="books-form">
                <input type="hidden" id="current-book-id">
                <input type="file" id="photo-upload" style="display: none;" accept="image/*" capture="environment"/>
                <div class="row">
                    <!-- Left side: Form fields and action buttons -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="new-book-title" class="form-label">Book Title:</label>
                            <input type="text" id="new-book-title" class="form-control" placeholder="New book title" autocomplete="off" data-test="new-book-title">
                        </div>
                        <div class="mb-3">
                            <label for="new-book-year" class="form-label">Publication Year:</label>
                            <input type="number" id="new-book-year" class="form-control" placeholder="Publication Year" autocomplete="off" data-test="new-book-year">
                        </div>
                        <div class="mb-3">
                            <label for="new-book-publisher" class="form-label">Publisher:</label>
                            <input type="text" id="new-book-publisher" class="form-control" placeholder="Publisher" autocomplete="off" data-test="new-book-publisher">
                        </div>
                        <div class="mb-3">
                            <label for="new-book-summary" class="form-label">Plot Summary:</label>
                            <textarea id="new-book-summary" class="form-control" placeholder="Plot Summary" autocomplete="off" data-test="new-book-summary"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="new-book-related" class="form-label">Related Works:</label>
                            <input type="text" id="new-book-related" class="form-control" placeholder="Related Works" autocomplete="off" data-test="new-book-related">
                        </div>
                        <div class="mb-3">
                            <label for="new-book-description" class="form-label">Detailed Description:</label>
                            <textarea id="new-book-description" class="form-control" placeholder="Detailed Description" autocomplete="off" data-test="new-book-description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="new-book-added" class="form-label">Date Added to Library:</label>
                            <input type="date" id="new-book-added" class="form-control" autocomplete="off" data-test="new-book-added">
                        </div>
                        <div class="mb-3">
                            <label for="new-book-status" class="form-label">Status:</label>
                            <select id="new-book-status" class="form-select" data-test="new-book-status">
                                <option value="ACTIVE">Active</option>
                                <option value="LOST">Lost</option>
                                <option value="WITHDRAWN">Withdrawn</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="new-book-loc" class="form-label">LOC Call Number:</label>
                            <input type="text" id="new-book-loc" class="form-control" placeholder="LOC Call Number" autocomplete="off" data-test="new-book-loc">
                        </div>
                        <div class="mb-3">
                            <label for="new-book-status-reason" class="form-label">Status Reason:</label>
                            <input type="text" id="new-book-status-reason" class="form-control" placeholder="Status Reason" autocomplete="off" data-test="new-book-status-reason">
                        </div>
                        <div class="mb-3">
                            <label for="book-author" class="form-label">Author:</label>
                            <div class="input-group">
                                <input type="text" id="book-author" class="form-control" placeholder="Type to search authors..." autocomplete="off" list="author-datalist" data-test="book-author">
                                <button type="button" class="btn btn-outline-secondary" id="clear-author-btn" title="Clear author">âœ•</button>
                            </div>
                            <datalist id="author-datalist"></datalist>
                            <input type="hidden" id="book-author-id" data-test="book-author-id">
                        </div>
                        <div class="mb-3">
                            <label for="book-library" class="form-label">Library:</label>
                            <select id="book-library" class="form-select" data-test="book-library"></select>
                        </div>
                        <button id="add-book-btn" class="btn btn-primary mb-3" onclick="addBook()" data-test="add-book-btn">Add Book</button>
                        <button id="cancel-book-btn" class="btn btn-secondary mb-3" onclick="resetBookForm()" data-test="cancel-book-btn" style="display: none;">Cancel</button>
                    </div>
                    <!-- Right side: Photo buttons and photos -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <button id="add-photo-btn" class="btn btn-secondary" onclick="addPhoto()" data-test="add-photo-btn" style="display: none;">Add Photo</button>
                            <button id="add-photo-google-btn" class="btn btn-secondary" onclick="addPhotoFromGooglePhotos()" data-test="add-photo-google-btn" style="display: none;">Add Photo from Google Photos</button>
                            <button id="book-by-photo-btn" class="btn btn-secondary" onclick="createBookByPhoto()" data-test="book-by-photo-btn" style="display: none;">Book-by-Photo</button>
                        </div>
                        <div id="book-photos-container" class="mb-3" style="display: none;" data-test="book-photos-container">
                            <h3 data-test="book-photos-header">Book Photos</h3>
                            <div id="book-photos" data-test="book-photos"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="books-from-feed-section" class="section" data-test="books-from-feed-section">
            <h2 data-test="books-from-feed-header">Import Book Photos from Google Photos</h2>
            <div class="card mb-3">
                <div class="card-body">
                    <p>This feature imports photos from your Google Photos account to automatically detect and create card catalog entries.</p>
                    <p><strong>How it works (Two-Phase Process):</strong></p>
                    <ol>
                        <li><strong>Phase 1 - Select & Save Photos:</strong> Open Google Photos Picker, select photos, and save them to the database</li>
                        <li><strong>Phase 2 - Process with AI:</strong> Uses AI to extract book information from saved photos and create book entries</li>
                    </ol>
                    <p><strong>Note:</strong> Make sure you have authorized Google Photos in Settings.</p>
                    <div class="btn-group mb-2" role="group">
                        <button id="select-photos-btn" class="btn btn-primary" onclick="selectPhotosFromPicker()" data-test="select-photos-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Step 1: Select & Save Photos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Saved Books Table -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Step 2: Process Saved Photos with AI</h5>
                    <div class="btn-group" role="group">
                        <button id="view-saved-books-btn" class="btn btn-sm btn-secondary" onclick="loadSavedBooks()" data-test="view-saved-books-btn">
                            View Saved Books
                        </button>
                        <button id="process-all-btn" class="btn btn-sm btn-success" onclick="processAllBooks()" data-test="process-all-btn">
                            Process All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="saved-books-table" data-test="saved-books-table">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Title/Author</th>
                                    <th>LOC Call Number</th>
                                    <th>Status</th>
                                    <th>Result</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="saved-books-table-body" data-test="saved-books-table-body">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No saved books to display. Click "View Saved Books" to load.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="processing-results" data-test="processing-results"></div>
        </div>

        <div id="photos-section" class="section" data-test="photos-section">
            <h2 data-test="photos-header">Photo Import/Export Status</h2>
            <div class="card mb-3">
                <div class="card-body">
                    <p>This page shows the import/export status of all photos in the library with Google Photos.</p>
                    <p><strong>How it works:</strong></p>
                    <ul>
                        <li>Photos are exported to Google Photos and assigned a permanent ID</li>
                        <li>Photos can be imported from Google Photos using their permanent ID</li>
                        <li>An album is created to hold the photos, named after this library</li>
                        <li>You can manually trigger import/export for all pending photos or individual photos</li>
                    </ul>
                    <p id="album-info" class="mb-2"><strong>Google Photos Album:</strong> <span id="album-name" class="font-monospace text-primary">Loading...</span></p>
                    <p><strong>Note:</strong> Make sure Google Photos API is configured in Settings.</p>

                    <div class="d-flex gap-2 mb-3">
                        <button id="export-all-photos-btn" class="btn btn-primary" onclick="exportAllPhotos()" data-test="export-all-photos-btn">Export All Pending Photos</button>
                        <button id="import-all-photos-btn" class="btn btn-success" onclick="importAllPhotos()" data-test="import-all-photos-btn">Import All Pending Photos</button>
                        <button id="refresh-photos-btn" class="btn btn-secondary" onclick="loadPhotoExportStatus()" data-test="refresh-photos-btn">Refresh Status</button>
                    </div>

                    <div id="export-stats" class="row mb-3" data-test="export-stats">
                        <div class="col-md-2">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">Total Photos</h6>
                                    <p class="card-text fs-4" id="stats-total">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card text-center bg-success text-white">
                                <div class="card-body">
                                    <h6 class="card-title">Exported</h6>
                                    <p class="card-text fs-4" id="stats-exported">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card text-center bg-info text-white">
                                <div class="card-body">
                                    <h6 class="card-title">Imported</h6>
                                    <p class="card-text fs-4" id="stats-imported">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card text-center bg-warning">
                                <div class="card-body">
                                    <h6 class="card-title">Pending Export</h6>
                                    <p class="card-text fs-4" id="stats-pending-export">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card text-center bg-secondary text-white">
                                <div class="card-body">
                                    <h6 class="card-title">Pending Import</h6>
                                    <p class="card-text fs-4" id="stats-pending-import">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card text-center bg-danger text-white">
                                <div class="card-body">
                                    <h6 class="card-title">Failed</h6>
                                    <p class="card-text fs-4" id="stats-failed">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Photo Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" data-test="photos-table">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Title/Author</th>
                                    <th scope="col">LOC Call Number</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Backed Up At</th>
                                    <th scope="col">Permanent ID</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="photos-table-body" data-test="photos-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="search-section" class="section" data-test="search-section">
            <h2 data-test="search-header">Search</h2>
            <div class="input-group mb-3" data-test="search-form">
                <input type="text" id="search-input" class="form-control" placeholder="Search books and authors..." autocomplete="off" data-test="search-input">
                <button class="btn btn-primary" onclick="performSearch()" data-test="search-btn">Search</button>
            </div>
            <div id="search-results" data-test="search-results"></div>
        </div>

        <div id="library-card-section" class="section" data-test="library-card-section">
            <!--
                IMPORTANT: Print Library Card Section - MUST be shown for logged-in users!
                This section allows users to select a card design and print their library card.
                It is shown/hidden by loadLibraryCardSection() in librarycard.js based on login status.
                Works for both SSO users and traditional login users.
            -->
            <div id="print-card-section" class="mt-5" data-test="print-card-section" style="display: none;">
                <h2 data-test="print-card-header">Print Your Library Card</h2>
                <p class="text-muted">Select your preferred card design and print a wallet-sized library card.</p>

                <div class="mb-4">
                    <label class="form-label"><strong>Select Card Design:</strong></label>
                    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-5 g-3" id="card-design-selector" data-test="card-design-selector">
                        <div class="col">
                            <input type="radio" class="btn-check" name="card-design" id="design-countryside-youth" value="COUNTRYSIDE_YOUTH" autocomplete="off" data-test="design-countryside-youth">
                            <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center p-2" for="design-countryside-youth">
                                <img src="/images/library-cards/countryside_youth.jpg" class="img-fluid rounded mb-2" alt="Countryside Youth" style="max-height: 150px; object-fit: cover;">
                                <small>Countryside Youth</small>
                            </label>
                        </div>
                        <div class="col">
                            <input type="radio" class="btn-check" name="card-design" id="design-sacred-heart" value="SACRED_HEART_PORTRAIT" autocomplete="off" data-test="design-sacred-heart">
                            <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center p-2" for="design-sacred-heart">
                                <img src="/images/library-cards/sacred_heart_portrait.jpg" class="img-fluid rounded mb-2" alt="Sacred Heart Portrait" style="max-height: 150px; object-fit: cover;">
                                <small>Sacred Heart Portrait</small>
                            </label>
                        </div>
                        <div class="col">
                            <input type="radio" class="btn-check" name="card-design" id="design-radiant-blessing" value="RADIANT_BLESSING" autocomplete="off" data-test="design-radiant-blessing">
                            <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center p-2" for="design-radiant-blessing">
                                <img src="/images/library-cards/radiant_blessing.jpg" class="img-fluid rounded mb-2" alt="Radiant Blessing" style="max-height: 150px; object-fit: cover;">
                                <small>Radiant Blessing</small>
                            </label>
                        </div>
                        <div class="col">
                            <input type="radio" class="btn-check" name="card-design" id="design-patron-creatures" value="PATRON_OF_CREATURES" autocomplete="off" data-test="design-patron-creatures">
                            <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center p-2" for="design-patron-creatures">
                                <img src="/images/library-cards/patron_of_creatures.jpg" class="img-fluid rounded mb-2" alt="Patron of Creatures" style="max-height: 150px; object-fit: cover;">
                                <small>Patron of Creatures</small>
                            </label>
                        </div>
                        <div class="col">
                            <input type="radio" class="btn-check" name="card-design" id="design-classical-devotion" value="CLASSICAL_DEVOTION" autocomplete="off" data-test="design-classical-devotion">
                            <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center p-2" for="design-classical-devotion">
                                <img src="/images/library-cards/classical_devotion.jpg" class="img-fluid rounded mb-2" alt="Classical Devotion" style="max-height: 150px; object-fit: cover;">
                                <small>Classical Devotion</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <button id="save-card-design-btn" class="btn btn-success" onclick="saveCardDesign()" data-test="save-card-design-btn">
                        Save Design Preference
                    </button>
                    <button id="print-card-btn" class="btn btn-primary ms-2" onclick="printLibraryCard()" data-test="print-card-btn">
                        Print Library Card (PDF)
                    </button>
                </div>

                <div id="card-design-success" class="alert alert-success mt-3" style="display: none;" data-test="card-design-success"></div>
                <div id="card-design-error" class="alert alert-danger mt-3" style="display: none;" data-test="card-design-error"></div>
            </div>

            <div id="applied-section" class="librarian-only mt-5" data-test="applied-section">
                <h2 data-test="applied-header">Library Card Applications</h2>
                <table class="table" data-test="applied-table">
                    <thead>
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Status</th>
                        <th scope="col">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="applied-list-body" data-test="applied-list-body">
                    </tbody>
                </table>
            </div>

            <div id="apply-for-card-section" class="mt-5" data-test="apply-for-card-section">
                <h2 data-test="apply-for-card-header">Apply for a Library Card</h2>
                <form data-test="apply-for-card-form">
                    <div class="mb-3">
                        <label for="new-applicant-name" class="form-label">Name:</label>
                        <input type="text" id="new-applicant-name" class="form-control" placeholder="Your Name" autocomplete="off" data-test="new-applicant-name">
                    </div>
                    <div class="mb-3">
                        <label for="new-applicant-password" class="form-label">Password:</label>
                        <input type="password" id="new-applicant-password" class="form-control" placeholder="Password" autocomplete="new-password" data-test="new-applicant-password">
                    </div>
                    <button id="apply-for-card-btn" type="button" class="btn btn-primary" onclick="applyForCard()" data-test="apply-for-card-btn">Apply</button>
                </form>
                <div id="apply-error" class="alert alert-danger mt-3" style="display: none;" data-test="apply-error"></div>
                <div id="apply-success" class="alert alert-success mt-3" style="display: none;" data-test="apply-success"></div>
            </div>
        </div>

        <div id="users-section" class="section librarian-only" data-test="users-section">
            <h2 data-test="users-header">Users</h2>
            <table class="table" data-test="user-table">
                <thead>
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Books on Loan</th>
                        <th scope="col">SSO</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="user-list-body" data-test="user-list-body">
                </tbody>
            </table>
            <form data-test="users-form">
                <div class="mb-3">
                    <label for="new-user-username" class="form-label">Name:</label>
                    <input type="text" id="new-user-username" class="form-control" placeholder="Name" autocomplete="off" data-test="new-user-username">
                </div>
                <div class="mb-3">
                    <label for="new-user-password" class="form-label">Password:</label>
                    <input type="password" id="new-user-password" class="form-control" placeholder="Password" autocomplete="new-password" data-test="new-user-password">
                </div>
                <div class="mb-3">
                    <label for="new-user-role" class="form-label">Role:</label>
                    <select id="new-user-role" class="form-select" data-test="new-user-role">
                        <option value="LIBRARIAN">Librarian</option>
                        <option value="USER">User</option>
                    </select>
                </div>
                <button id="add-user-btn" type="button" class="btn btn-primary" onclick="addUser()" data-test="add-user-btn">Add User</button>
            </form>
        </div>

        <div id="loans-section" class="section" data-test="loans-section">
            <h2 data-test="loans-header">Loans</h2>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="" id="show-returned-loans" onchange="loadLoans()" data-test="show-returned-loans-checkbox">
                <label class="form-check-label" for="show-returned-loans">
                    Show returned loans
                </label>
            </div>
            <table class="table" data-test="loan-table">
                <thead>
                    <tr>
                        <th scope="col">Book Title</th>
                        <th scope="col">Name</th>
                        <th scope="col">Loan Date</th>
                        <th scope="col">Due Date</th>
                        <th scope="col">Return Date</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="loan-list-body" data-test="loan-list-body">
                </tbody>
            </table>
            <div class="librarian-only" data-test="loans-form">
                <div class="mb-3">
                    <label for="loan-book" class="form-label">Book:</label>
                    <select id="loan-book" class="form-select" data-test="loan-book" data-test-form="loan-book-select"></select>
                </div>
                <div class="mb-3">
                    <label for="loan-user" class="form-label">Name:</label>
                    <select id="loan-user" class="form-select" data-test="loan-user" data-test-form="loan-user-select"></select>
                </div>
                <div class="mb-3">
                    <label for="loan-date" class="form-label">Loan Date:</label>
                    <input type="date" id="loan-date" class="form-control" data-test="loan-date" data-test-form="loan-date-input">
                </div>
                <div class="mb-3">
                    <label for="due-date" class="form-label">Due Date:</label>
                    <input type="date" id="due-date" class="form-control" data-test="due-date" data-test-form="due-date-input">
                </div>
                <div class="mb-3">
                    <label for="return-date" class="form-label">Return Date:</label>
                    <input type="date" id="return-date" class="form-control" data-test="return-date" data-test-form="return-date-input">
                </div>
                <button id="checkout-btn" class="btn btn-primary" onclick="checkoutBook()" data-test="checkout-btn">Checkout Book</button>
            </div>
        </div>

        <div id="test-data-section" class="section" data-test="test-data-section">
            <h2 data-test="test-data-header">Generate Test Data</h2>
            <div id="test-data-stats" class="mb-3" data-test="test-data-stats"></div>
            <div class="mb-3">
                <label for="num-books" class="form-label">Number of Items to Add:</label>
                <input type="number" id="num-books" class="form-control" placeholder="Number of items" data-test="num-books">
            </div>
            <button id="generate-test-data-btn" class="btn btn-primary" onclick="generateTestData()" data-test="generate-test-data-btn">Add Random Books</button>
            <button id="generate-test-loans-btn" class="btn btn-success" onclick="generateTestLoans()" data-test="generate-test-loans-btn">Add-Random-Loans</button>
            <button id="delete-all-test-data-btn" class="btn btn-danger" onclick="deleteAllTestData()" data-test="delete-all-test-data-btn">Delete All Test Data</button>
            <button id="total-purge-btn" class="btn btn-dark" onclick="totalPurge()" data-test="total-purge-btn">Total Purge</button>
        </div>

        <!-- Global Settings Section (Librarian-only) -->
        <div id="global-settings-section" class="section librarian-only" data-test="global-settings-section">
            <h2 data-test="global-settings-header">Global Settings</h2>
            <p class="text-muted">These settings apply to all users and can only be changed by librarians.</p>

            <div class="row">
                <!-- Google Photos OAuth Column -->
                <div class="col-md-6">
                    <div class="card mb-3 h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Google Photos OAuth</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-5"><strong>Client ID:</strong></div>
                                <div class="col-7">
                                    <code id="global-client-id" data-test="global-client-id" style="word-break: break-all; font-size: 0.8em;">(loading...)</code>
                                    <span id="global-client-id-configured" data-test="global-client-id-configured"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5"><strong>Client Secret:</strong></div>
                                <div class="col-7">
                                    <span id="global-secret-partial" data-test="global-secret-partial">(loading...)</span>
                                    <span id="global-secret-configured" data-test="global-secret-configured"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5"><strong>Redirect URI:</strong></div>
                                <div class="col-7"><code id="global-redirect-uri" data-test="global-redirect-uri" style="word-break: break-all; font-size: 0.8em;">(loading...)</code></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5"><strong>Secret Validation:</strong></div>
                                <div class="col-7"><span id="global-secret-validation" data-test="global-secret-validation"></span></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-5"><strong>Last Updated:</strong></div>
                                <div class="col-7"><span id="global-secret-updated-at" data-test="global-secret-updated-at">(loading...)</span></div>
                            </div>

                            <form id="global-settings-form" onsubmit="saveGlobalSettings(event)" data-test="global-settings-form">
                                <div class="mb-3">
                                    <label for="global-client-id-input" class="form-label">Client ID</label>
                                    <input type="text" id="global-client-id-input" class="form-control form-control-sm" autocomplete="off" placeholder="Enter Google Photos OAuth Client ID" data-test="global-client-id-input">
                                </div>
                                <div class="mb-3">
                                    <label for="global-client-secret" class="form-label">Client Secret</label>
                                    <input type="password" id="global-client-secret" class="form-control form-control-sm" autocomplete="off" placeholder="Enter Google Photos OAuth Client Secret" data-test="global-client-secret">
                                </div>
                                <button type="submit" class="btn btn-warning btn-sm" data-test="update-global-secret-btn">Update Photos OAuth</button>
                            </form>
                            <div id="global-settings-error" class="alert alert-danger mt-3 py-2" style="display: none;" data-test="global-settings-error"></div>
                            <div id="global-settings-success" class="alert alert-success mt-3 py-2" style="display: none;" data-test="global-settings-success"></div>
                        </div>
                    </div>
                </div>

                <!-- Google SSO Column -->
                <div class="col-md-6">
                    <div class="card mb-3 h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Google SSO (User Login)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-5"><strong>Client ID:</strong></div>
                                <div class="col-7">
                                    <code id="global-sso-client-id" data-test="global-sso-client-id" style="word-break: break-all; font-size: 0.8em;">(loading...)</code>
                                    <span id="global-sso-client-id-configured" data-test="global-sso-client-id-configured"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5"><strong>Client Secret:</strong></div>
                                <div class="col-7">
                                    <span id="global-sso-secret-partial" data-test="global-sso-secret-partial">(loading...)</span>
                                    <span id="global-sso-secret-configured" data-test="global-sso-secret-configured"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5"><strong>Redirect URI:</strong></div>
                                <div class="col-7"><code id="global-sso-redirect-uri" data-test="global-sso-redirect-uri" style="word-break: break-all; font-size: 0.8em;">(loading...)</code></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5"><strong>Secret Validation:</strong></div>
                                <div class="col-7"><span id="global-sso-secret-validation" data-test="global-sso-secret-validation"></span></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-5"><strong>Last Updated:</strong></div>
                                <div class="col-7"><span id="global-sso-updated-at" data-test="global-sso-updated-at">(loading...)</span></div>
                            </div>

                            <form id="global-sso-settings-form" onsubmit="saveGlobalSsoSettings(event)" data-test="global-sso-settings-form">
                                <div class="mb-3">
                                    <label for="global-sso-client-id-input" class="form-label">Client ID</label>
                                    <input type="text" id="global-sso-client-id-input" class="form-control form-control-sm" autocomplete="off" placeholder="Enter Google SSO Client ID" data-test="global-sso-client-id-input">
                                </div>
                                <div class="mb-3">
                                    <label for="global-sso-client-secret-input" class="form-label">Client Secret</label>
                                    <input type="password" id="global-sso-client-secret-input" class="form-control form-control-sm" autocomplete="off" placeholder="Enter Google SSO Client Secret" data-test="global-sso-client-secret-input">
                                </div>
                                <button type="submit" class="btn btn-warning btn-sm" data-test="update-global-sso-btn">Update SSO OAuth</button>
                            </form>
                            <div id="global-sso-settings-error" class="alert alert-danger mt-3 py-2" style="display: none;" data-test="global-sso-settings-error"></div>
                            <div id="global-sso-settings-success" class="alert alert-success mt-3 py-2" style="display: none;" data-test="global-sso-settings-success"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOC Bulk Lookup Section (Librarian-only) -->
        <div id="loc-bulk-lookup-section" class="section librarian-only" data-test="loc-bulk-lookup-section">
            <h2 data-test="loc-bulk-lookup-header">LOC Bulk Lookup</h2>
            <p class="text-muted">Lookup Library of Congress call numbers for books in bulk.</p>

            <div class="mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" id="view-all-books-btn" data-test="view-all-books-btn">
                        View All Books
                    </button>
                    <button type="button" class="btn btn-warning" id="view-missing-loc-btn" data-test="view-missing-loc-btn">
                        View Books Missing LOC
                    </button>
                </div>
                <button type="button" class="btn btn-success ms-3" id="lookup-all-missing-btn" data-test="lookup-all-missing-btn">
                    Lookup All Missing LOC Call Numbers
                </button>
            </div>

            <div id="loc-lookup-progress" class="alert alert-info" style="display: none;" data-test="loc-lookup-progress">
                Processing... <span id="loc-lookup-progress-text"></span>
            </div>

            <div id="loc-lookup-results" class="alert alert-success" style="display: none;" data-test="loc-lookup-results"></div>
            <div id="loc-lookup-error" class="alert alert-danger" style="display: none;" data-test="loc-lookup-error"></div>

            <table class="table table-striped" data-test="loc-lookup-table">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Book</th>
                        <th>LOC Call Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="loc-lookup-table-body" data-test="loc-lookup-table-body">
                    <tr>
                        <td colspan="4" class="text-center">Click a button above to load books</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="labels-section" class="section librarian-only" data-test="labels-section">
            <h2 data-test="labels-header">Labels</h2>
            <p class="text-muted">Generate Avery 6572 labels (2" x 2-5/8") for books with LOC call numbers.</p>

            <div class="mb-3">
                <button type="button" class="btn btn-primary" id="load-books-for-labels-btn" data-test="load-books-for-labels-btn">
                    Load Books for Labels
                </button>
                <button type="button" class="btn btn-success ms-3" id="generate-all-labels-btn" data-test="generate-all-labels-btn">
                    Generate PDF for All Books
                </button>
                <button type="button" class="btn btn-warning ms-2" id="generate-selected-labels-btn" data-test="generate-selected-labels-btn">
                    Generate PDF for Selected
                </button>
            </div>

            <div id="labels-results" class="alert alert-success" style="display: none;" data-test="labels-results"></div>
            <div id="labels-error" class="alert alert-danger" style="display: none;" data-test="labels-error"></div>

            <table class="table table-striped" data-test="labels-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-labels" data-test="select-all-labels"></th>
                        <th>Photo</th>
                        <th>Title/Author</th>
                        <th>LOC Call Number</th>
                        <th>Date Added</th>
                    </tr>
                </thead>
                <tbody id="labels-table-body" data-test="labels-table-body">
                    <tr>
                        <td colspan="5" class="text-center">Click "Load Books for Labels" to see books</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="settings-section" class="section" data-test="settings-section">
            <h2 data-test="settings-header">User Settings</h2>
            <form id="settings-form" onsubmit="saveSettings(event)">
                <div class="mb-3">
                    <label for="user-name" class="form-label">Name</label>
                    <input type="text" id="user-name" class="form-control" autocomplete="name" data-test="user-name">
                </div>
                <div class="mb-3">
                    <label for="user-password" class="form-label">New Password</label>
                    <input type="password" id="user-password" class="form-control" autocomplete="new-password" data-test="user-password">
                    <div class="form-text">Leave blank to keep your current password.</div>
                </div>
                <div class="mb-3">
                    <label for="xai-api-key" class="form-label">XAI API Key (for AI features)</label>
                    <input type="text" id="xai-api-key" class="form-control" autocomplete="off" placeholder="Enter your xAI API key" data-test="xai-api-key">
                    <div class="form-text">This key enables AI-powered search and recommendations. Get one from x.ai.</div>
                </div>
                <div class="mb-3 librarian-only">
                    <label class="form-label">Google Photos Access (for Books-from-Feed)</label>
                    <div id="google-photos-status" class="mb-2">
                        <span id="google-photos-authorized" class="badge bg-success" style="display: none;">Authorized</span>
                        <span id="google-photos-not-authorized" class="badge bg-warning">Not Authorized</span>
                    </div>
                    <button type="button" id="authorize-google-photos-btn" class="btn btn-primary btn-sm" onclick="authorizeGooglePhotos()">
                        Authorize Google Photos
                    </button>
                    <button type="button" id="revoke-google-photos-btn" class="btn btn-danger btn-sm" onclick="revokeGooglePhotos()" style="display: none;">
                        Revoke Access
                    </button>
                    <div class="form-text">Authorize access to your Google Photos for the Books-from-Feed feature.</div>
                    <input type="hidden" id="google-photos-api-key" data-test="google-photos-api-key">
                </div>
                <div class="mb-3 librarian-only">
                    <label for="google-photos-album-id" class="form-label">Google Photos Album ID</label>
                    <input type="text" id="google-photos-album-id" class="form-control font-monospace" autocomplete="off" placeholder="Album ID (auto-created on first export)" data-test="google-photos-album-id">
                    <div class="form-text">
                        This is the permanent ID of the album where photos are exported. It's automatically created on the first export.
                        You can manually set it to use a different album.
                    </div>
                </div>
                <div class="mb-3">
                    <label for="settings-card-design" class="form-label">Library Card Design</label>
                    <select id="settings-card-design" class="form-select" data-test="settings-card-design">
                        <option value="COUNTRYSIDE_YOUTH">Countryside Youth</option>
                        <option value="SACRED_HEART_PORTRAIT">Sacred Heart Portrait</option>
                        <option value="RADIANT_BLESSING">Radiant Blessing</option>
                        <option value="PATRON_OF_CREATURES">Patron of Creatures</option>
                        <option value="CLASSICAL_DEVOTION">Classical Devotion</option>
                    </select>
                    <div class="form-text">Choose your preferred library card design. You can preview and print your card in the Library Card section.</div>
                </div>
                <button type="submit" class="btn btn-primary" data-test="save-settings-btn">Save User Settings</button>
            </form>
            <div id="settings-error" class="alert alert-danger mt-3" style="display: none;" data-test="settings-error"></div>
            <div id="settings-success" class="alert alert-success mt-3" style="display: none;" data-test="settings-success"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script src="js/books-table.js"></script>
<script src="js/books-edit.js"></script>
<script src="js/books-photo.js"></script>
<script src="js/books-from-feed.js"></script>
<script src="js/photos.js"></script>
<script src="js/libraries.js"></script>
<script src="js/authors-table.js"></script>
<script src="js/authors-edit.js"></script>
<script src="js/authors-photo.js"></script>
<script src="js/users.js" type="module"></script>
<script src="js/loans.js"></script>
<script src="js/librarycard.js" type="module"></script>
<script src="js/search.js"></script>
<script src="js/settings.js" type="module"></script>
<script src="js/global-settings.js"></script>
<script src="js/loc-bulk-lookup.js" type="module"></script>
<script src="js/labels.js" type="module"></script>
<script src="js/test-data.js"></script>
<script src="js/utils.js" type="module"></script>
<script src="js/auth.js" type="module"></script>
<script src="js/sections.js" type="module"></script>
<script src="js/init.js" type="module"></script>
<script src="js/app.js" type="module"></script>

</body>
</html>
